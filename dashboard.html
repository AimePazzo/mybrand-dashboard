<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="shortcut icon" href="images/logo.png" type="image/x-icon" />

    <link rel="stylesheet" href="style.css" />
    <title>MY Brand | Dashboard</title>
  </head>

  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="#" class="logo">
        <i class="bx bx-code-alt"></i>
        <div class="logo-name"><span>My</span>Brand</div>
      </a>
      <ul class="side-menu">
        <li class="active">
          <a href="#"><i class="bx bxs-dashboard"></i>Dashboard</a>
        </li>
        <!-- <li>
          <a href="#" id="blog-link"><i class="bx bx-bookmarks"></i>Blog</a>
        </li> -->
        <li>
          <a href="#" id="project-link"><i class="bx bx-analyse"></i>Project</a>
        </li>
        <li>
          <a href="#" id="message-link"
            ><i class="bx bx-message-square-dots"></i>Message</a
          >
        </li>
        <li>
          <a href="#" id="user-link"><i class="bx bx-group"></i>Users</a>
        </li>
        <!-- <li>
          <a href="#" id="settings-link"><i class="bx bx-cog"></i>Settings</a>
        </li> -->
      </ul>
      <ul class="side-menu">
        <li>
          <a href="#" class="logout" id="logout">
            <i class="bx bx-log-out-circle"></i>
            Logout
          </a>
        </li>
      </ul>
    </div>
    <!-- End of Sidebar -->

    <!-- Main Content -->
    <div class="content">
      <!-- Navbar -->
      <nav>
        <i class="bx bx-menu"></i>
        <form action="#">
          <div class="form-input">
            <input type="search" placeholder="Search..." />
            <button class="search-btn" type="submit">
              <i class="bx bx-search"></i>
            </button>
          </div>
        </form>
        <input type="checkbox" id="theme-toggle" hidden />
        <label for="theme-toggle" class="theme-toggle"></label>
        <a href="#" class="notif">
          <i class="bx bx-bell"></i>
          <span class="count">12</span>
        </a>
        <a href="#" class="profile">
          <img src="images/logo.png" />
        </a>
      </nav>

      <!-- End of Navbar -->

      <main id="content-dashboard">
        <div class="header">
          <div class="left">
            <h1>Dashboard</h1>
          </div>
        </div>

        <!-- Insights -->
        <ul class="insights">
          <li>
            <i class="bx bx-user"></i>
            <span class="info">
              <h3>0</h3>
              <p>Users</p>
            </span>
          </li>
          <li>
            <i class="bx bx-show-alt"></i>
            <span class="info">
              <h3>0</h3>
              <p>Project</p>
            </span>
          </li>
          <li>
            <i class="bx bx-line-chart"></i>
            <span class="info">
              <h3>0</h3>
              <p>Blog</p>
            </span>
          </li>
        </ul>
      </main>

      <main id="content-project" class="hide-content">
        <div class="header">
          <div class="left">
            <h1>Project</h1>
          </div>
        </div>

        <!-- Insights -->
        <div class="addProject">
          <button id="openForm">Add Project</button>
        </div>
        <!-- End of Insights -->

        <!-- Pop up form -->
        <div class="form-popup" id="projectForm">
          <form
            class="form-container"
            id="project-form"
            enctype="multipart/form-data"
          >
            <h2 id="form-title">Add New Project</h2>
            <label for="title"><b>Title</b></label>
            <input
              type="text"
              placeholder="Enter Title"
              name="title"
              id="title"
              required
            />

            <label for="title"><b>Field</b></label>
            <input
              type="text"
              placeholder="Enter Field"
              name="field"
              id="field"
              required
            />

            <label for="description"><b>Description</b></label>
            <textarea
              placeholder="Enter Description"
              name="description"
              id="description"
              required
            ></textarea>

            <label for="image"><b>Image</b></label>
            <input type="file" name="image" accept="image/*" required />

            <button type="submit" class="btn" id="form-submit-button">
              Submit
            </button>
            <button type="button" class="btn cancel project" id="closeForm">
              Close
            </button>
          </form>
        </div>

        <!-- End of Pop up form  -->
        <div class="bottom-data">
          <div class="orders">
            <div class="header">
              <i class="bx bx-receipt"></i>
              <h3>Project List</h3>
              <i class="bx bx-filter"></i>
              <i class="bx bx-search"></i>
            </div>
            <table>
              <thead>
                <tr>
                  <th>N<sup>0</sup></th>
                  <th>Project Title</th>
                  <th>Project Field</th>
                  <th>Project Image</th>
                  <th>Project Description</th>
                  <th>action</th>
                </tr>
              </thead>
              <tbody id="project-table-body">
                <!-- Data will be displayed here -->
              </tbody>
            </table>
          </div>
        </div>
      </main>

      <!-- User Content -->

      <main id="content-user" class="hide-content">
        <div class="header">
          <div class="left">
            <h1>Users</h1>
          </div>
        </div>

        <div class="bottom-data">
          <div class="orders">
            <div class="header">
              <i class="bx bx-receipt"></i>
              <h3>Users</h3>
              <i class="bx bx-filter"></i>
              <i class="bx bx-search"></i>
            </div>
            <table>
              <thead>
                <tr>
                  <th>N<sup>0</sup></th>
                  <th>UserName</th>
                  <th>Full Name</th>
                  <th>Email</th>
                </tr>
              </thead>
              <tbody id="user-table-body">
                <!-- Data will be displayed here -->
              </tbody>
            </table>
          </div>
        </div>
      </main>

      <!-- <main id="content-settings" class="hide-content">
        <div class="header">
          <div class="left">
            <h1>Settings</h1>
          </div>
        </div>
        <div class="bottom-data">
          <div class="orders">
            <div class="header">
              <i class="bx bx-receipt"></i>
              <h3>Recent Message</h3>
              <i class="bx bx-filter"></i>
              <i class="bx bx-search"></i>
            </div>
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <i class="bx bx-user"></i>

                    <p>John Doe</p>
                  </td>
                  <td>14-08-2023</td>
                  <td><span class="status completed">Completed</span></td>
                </tr>
                <tr>
                  <td>
                    <i class="bx bx-user"></i>

                    <p>John Doe</p>
                  </td>
                  <td>14-08-2023</td>
                  <td><span class="status pending">Pending</span></td>
                </tr>
                <tr>
                  <td>
                    <i class="bx bx-user"></i>

                    <p>John Doe</p>
                  </td>
                  <td>14-08-2023</td>
                  <td><span class="status process">Processing</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main> -->

      <main id="content-message" class="hide-content">
        <div class="header">
          <div class="left">
            <h1>Message</h1>
          </div>
        </div>

        <div class="bottom-data">
          <div class="orders">
            <div class="header">
              <i class="bx bx-receipt"></i>
              <h3>Messages</h3>
              <i class="bx bx-filter"></i>
              <i class="bx bx-search"></i>
            </div>
            <table>
              <thead>
                <tr>
                  <th>N<sup>0</sup></th>
                  <th>UserName</th>
                  <th>Email</th>
                  <th>Subject</th>
                  <th>Message</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="message-table-body">
                <!-- Data will be displayed here -->
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <script src="index.js"></script>
    <script>
      const openFormProject = document.getElementById("openForm");
      const openFormBlog = document.getElementById("openFormBlog");
      const closeFormButton = document.getElementById("closeForm");
      const closeFormBlog = document.getElementById("closeFormBlog");
      const projectForm = document.getElementById("projectForm");
      const blogForm = document.getElementById("blogForm");

      openFormProject.addEventListener("click", () => {
        projectForm.style.display = "block";
      });
      // openFormBlog.addEventListener("click", () => {
      //   blogForm.style.display = "block";
      // });
      closeFormButton.addEventListener("click", () => {
        projectForm.style.display = "none";
      });

      // closeFormBlog.addEventListener("click", () => {
      //   blogForm.style.display = "none";
      // });

      window.addEventListener("click", (event) => {
        if (event.target == projectForm) {
          projectForm.style.display = "none";
        } else if (event.target == blogForm) {
          blogForm.style.display = "none";
        }
      });

      document.getElementById("logout").addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "./index.html";
      });

      async function getMessage() {
        const response = await fetch(
          "https://backend-mybrand-2y5k.onrender.com/api/v1/contact/get-messages",
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
          }
        );
        const data = await response.json();
        const tbody = document.getElementById("message-table-body");

        data.forEach((message, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${index + 1}</td>
            <td>${message.userName}</td>
            <td>${message.email}</td>
            <td>${message.subject}</td>
            <td>${message.message}</td>
            <td><span class= "status ${message.status}">${
            message.status
          }</span></td>
          `;
          tbody.appendChild(row);
        });
      }

      async function getUsers() {
        try {
          const response = await fetch(
            "https://backend-mybrand-2y5k.onrender.com/api/v1/user/get-users",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
            }
          );
          const data = await response.json();
          console.log(data);
          const tbodyUser = document.getElementById("user-table-body");
          console.log(tbodyUser);
          data.forEach((user, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${index + 1}</td>
            <td>${user.userName}</td>
            <td>${user.firstName + " " + user.lastName}</td>
            <td>${user.email}</td>
          `;
            tbodyUser.appendChild(row);
          });
        } catch (error) {
          console.error(error);
        }
      }

      async function getProjects() {
        const response = await fetch(
          "https://backend-mybrand-2y5k.onrender.com/api/v1/project/get-projects",
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          }
        );
        const data = await response.json();
        console.log(data);
        const tbodyProject = document.getElementById("project-table-body");
        console.log(tbodyProject);
        data.forEach((project, index) => {
          const projectId = project._id;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${project.title}</td>
            <td>${project.field}</td>
            <td>
              <img src="${project.images[0].url}" alt="${
            project.title
          }" style="width:100px !important;height:100px !important">
              </td>
            <td>${project.description}</td>
            <td>
              <td>
              <div style="display:flex;gap:5px">
                <i class="bx bx-edit edit-icon" style="color:#D32F2F;cursor: pointer;" data-project-id="${
                  project._id
                }"></i>
                <i class="bx bx-trash" style="color:#1976D2;cursor: pointer;"></i>
                </div>
              </td>
          `;

          tbodyProject.appendChild(row);
        });
      }

      async function postProject(e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append("title", document.getElementById("title").value);
        formData.append("field", document.getElementById("field").value);
        formData.append(
          "description",
          document.getElementById("description").value
        );
        formData.append(
          "image",
          document.querySelector('input[type="file"]').files[0]
        );

        try {
          const response = await fetch(
            "https://backend-mybrand-2y5k.onrender.com/api/v1/project/post-project",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: formData,
            }
          );
          const data = await response.json();
          showToast(data.message, "success");
          console.log(data);

          const tbodyProject = document.getElementById("project-table-body");
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${tbodyProject.childElementCount + 1}</td>
          <td>${data.projectDetail.title}</td>
          <td>${data.projectDetail.field}</td>
          <td>
            <img src="${data.projectDetail.images[0].url}" alt="${
            data.projectDetail.title
          }" style="width:100px;height:100px">
          </td>
          <td>${data.projectDetail.description}</td>
          <td>
              <div style="display:flex;gap:5px">
                <i class="bx bx-edit edit-icon" style="color:#D32F2F;cursor: pointer;" data-project-id="${
                  project._id
                }"></i>
                <i class="bx bx-trash" style="color:#1976D2;cursor: pointer;"></i>
                </div>
              </td>
        `;
          tbodyProject.appendChild(row);
          projectForm.style.display = "none";
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function getProjectById(projectId) {
        try {
          const response = await fetch(
            `https://backend-mybrand-2y5k.onrender.com/api/v1/project/${projectId}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );
          const data = await response.json();
          console.log(data);
          return data.projectDetail;
        } catch (error) {
          console.error("Error fetching project:", error);
          return null;
        }
      }

      // Function to open the project form for editing
      function openProjectForm(project) {
        const projectForm = document.getElementById("projectForm");
        if (!projectForm) {
          console.error("Project form not found!");
          return;
        }
        projectForm.style.display = "block";
        document.getElementById("title").value = project.title;
        document.getElementById("field").value = project.field;
        document.getElementById("description").value = project.description;
        // Update submit button to update button
        const submitButton = document.querySelector(
          "#project-form button[type='submit']"
        );
        if (submitButton) {
          submitButton.textContent = "Update";
          submitButton.removeEventListener("click", postProject);
          submitButton.addEventListener("click", () =>
            updateProject(project._id)
          );
        } else {
          console.error("Submit button not found!");
        }
      }

      // Edit icon click event listener
      document.addEventListener("click", async (e) => {
        if (e.target && e.target.classList.contains("edit-icon")) {
          const projectId = e.target.dataset.projectId;
         
          const project = await getProjectById(projectId);
          console.log(project);
          if (project) {
            openProjectForm(project);
          }
        }
      });

      async function updateProject(projectId) {
        try {
          const formData = new FormData();
          formData.append("title", document.getElementById("title").value);
          formData.append("field", document.getElementById("field").value);
          formData.append(
            "description",
            document.getElementById("description").value
          );

          const response = await fetch(
            `https://backend-mybrand-2y5k.onrender.com/api/v1/project/${projectId}`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: formData,
            }
          );

          if (response.ok) {
            const updatedProject = await response.json();
            console.log("Project updated:", updatedProject);
            // Handle success, maybe show a success message or redirect
          } else {
            // Handle errors
            console.error("Failed to update project:", response.statusText);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      document
        .getElementById("project-form")
        .addEventListener("submit", postProject);

      async function getAllFunctions() {
        await getProjects();
        await getUsers();
        await getMessage();
      }
      document.addEventListener("DOMContentLoaded", getAllFunctions);
    </script>
  </body>
</html>
